Last login: Tue Dec 29 02:40:53 on ttys003

The default interactive shell is now zsh.
To update your account to use zsh, please run `chsh -s /bin/zsh`.
For more details, please visit https://support.apple.com/kb/HT208050.
MacBook-Air:~ anshitagoel$ ssh ubuntu@52.149.196.225
ubuntu@52.149.196.225's password: 
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-1031-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Dec 28 21:12:33 UTC 2020

  System load:  0.07              Processes:           118
  Usage of /:   4.5% of 28.90GB   Users logged in:     0
  Memory usage: 2%                IP address for eth0: 10.0.0.4
  Swap usage:   0%


0 packages can be updated.
0 updates are security updates.

New release '20.04.1 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


Last login: Mon Dec 28 18:37:39 2020 from 116.74.25.198
ubuntu@Master:~$ sudo su
root@Master:/home/ubuntu# hostname
Master
root@Master:/home/ubuntu# ssh ubuntu@13.65.39.24
ubuntu@13.65.39.24's password: 
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-1031-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Dec 28 21:13:47 UTC 2020

  System load:  0.0               Processes:           117
  Usage of /:   4.5% of 28.90GB   Users logged in:     0
  Memory usage: 2%                IP address for eth0: 10.0.1.5
  Swap usage:   0%


0 packages can be updated.
0 updates are security updates.

New release '20.04.1 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


Last login: Mon Dec 28 18:52:07 2020 from 52.149.196.225
ubuntu@worker02:~$ sudo su
root@worker02:/home/ubuntu#  $ apt-get update && apt-get install -y docker.io
$: command not found
root@worker02:/home/ubuntu# apt-get update && apt-get install -y docker.io
Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
Get:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease [88.7 kB]
Get:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease [74.6 kB]
Get:4 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 Packages [8570 kB]
Get:5 http://security.ubuntu.com/ubuntu bionic-security InRelease [88.7 kB]        
Get:6 http://azure.archive.ubuntu.com/ubuntu bionic/universe Translation-en [4941 kB]           
Get:7 http://azure.archive.ubuntu.com/ubuntu bionic/multiverse amd64 Packages [151 kB]    
Get:8 http://azure.archive.ubuntu.com/ubuntu bionic/multiverse Translation-en [108 kB]
Get:9 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages [1790 kB]
Get:10 http://azure.archive.ubuntu.com/ubuntu bionic-updates/main Translation-en [376 kB]
Get:11 http://azure.archive.ubuntu.com/ubuntu bionic-updates/restricted amd64 Packages [206 kB]
Get:12 http://azure.archive.ubuntu.com/ubuntu bionic-updates/restricted Translation-en [27.9 kB]
Get:13 http://azure.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 Packages [1697 kB]
Get:14 http://azure.archive.ubuntu.com/ubuntu bionic-updates/universe Translation-en [357 kB]
Get:15 http://azure.archive.ubuntu.com/ubuntu bionic-updates/multiverse amd64 Packages [35.6 kB]
Get:16 http://azure.archive.ubuntu.com/ubuntu bionic-updates/multiverse Translation-en [7180 B]
Get:17 http://azure.archive.ubuntu.com/ubuntu bionic-backports/main amd64 Packages [10.0 kB]
Get:18 http://azure.archive.ubuntu.com/ubuntu bionic-backports/main Translation-en [4764 B]
Get:19 http://azure.archive.ubuntu.com/ubuntu bionic-backports/universe amd64 Packages [10.3 kB]
Get:20 http://azure.archive.ubuntu.com/ubuntu bionic-backports/universe Translation-en [4588 B]
Get:21 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages [1453 kB]
Get:22 http://security.ubuntu.com/ubuntu bionic-security/main Translation-en [284 kB]
Get:23 http://security.ubuntu.com/ubuntu bionic-security/restricted amd64 Packages [185 kB]
Get:24 http://security.ubuntu.com/ubuntu bionic-security/restricted Translation-en [24.3 kB]
Get:25 http://security.ubuntu.com/ubuntu bionic-security/universe amd64 Packages [1094 kB]
Get:26 http://security.ubuntu.com/ubuntu bionic-security/universe Translation-en [244 kB]
Get:27 http://security.ubuntu.com/ubuntu bionic-security/multiverse amd64 Packages [12.8 kB]
Get:28 http://security.ubuntu.com/ubuntu bionic-security/multiverse Translation-en [2872 B]
Fetched 21.8 MB in 5s (4762 kB/s)                           
Reading package lists... Done
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following package was automatically installed and is no longer required:
  linux-headers-4.15.0-124
Use 'sudo apt autoremove' to remove it.
The following additional packages will be installed:
  bridge-utils cgroupfs-mount containerd pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools debootstrap docker-doc rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils cgroupfs-mount containerd docker.io pigz runc ubuntu-fan
0 upgraded, 7 newly installed, 0 to remove and 14 not upgraded.
Need to get 63.7 MB of archives.
After this operation, 319 MB of additional disk space will be used.
Get:1 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 pigz amd64 2.4-1 [57.4 kB]
Get:2 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 bridge-utils amd64 1.5-15ubuntu1 [30.1 kB]
Get:3 http://azure.archive.ubuntu.com/ubuntu bionic/universe amd64 cgroupfs-mount all 1.4 [6320 B]
Get:4 http://azure.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 runc amd64 1.0.0~rc10-0ubuntu1~18.04.2 [2000 kB]
Get:5 http://azure.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 containerd amd64 1.3.3-0ubuntu1~18.04.2 [21.7 MB]
Get:6 http://azure.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 docker.io amd64 19.03.6-0ubuntu1~18.04.2 [39.9 MB]
Get:7 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 ubuntu-fan all 0.12.10 [34.7 kB]
Fetched 63.7 MB in 2s (37.2 MB/s)      
Preconfiguring packages ...
Selecting previously unselected package pigz.
(Reading database ... 76696 files and directories currently installed.)
Preparing to unpack .../0-pigz_2.4-1_amd64.deb ...
Unpacking pigz (2.4-1) ...
Selecting previously unselected package bridge-utils.
Preparing to unpack .../1-bridge-utils_1.5-15ubuntu1_amd64.deb ...
Unpacking bridge-utils (1.5-15ubuntu1) ...
Selecting previously unselected package cgroupfs-mount.
Preparing to unpack .../2-cgroupfs-mount_1.4_all.deb ...
Unpacking cgroupfs-mount (1.4) ...
Selecting previously unselected package runc.
Preparing to unpack .../3-runc_1.0.0~rc10-0ubuntu1~18.04.2_amd64.deb ...
Unpacking runc (1.0.0~rc10-0ubuntu1~18.04.2) ...
Selecting previously unselected package containerd.
Preparing to unpack .../4-containerd_1.3.3-0ubuntu1~18.04.2_amd64.deb ...
Unpacking containerd (1.3.3-0ubuntu1~18.04.2) ...
Selecting previously unselected package docker.io.
Preparing to unpack .../5-docker.io_19.03.6-0ubuntu1~18.04.2_amd64.deb ...
Unpacking docker.io (19.03.6-0ubuntu1~18.04.2) ...
Selecting previously unselected package ubuntu-fan.
Preparing to unpack .../6-ubuntu-fan_0.12.10_all.deb ...
Unpacking ubuntu-fan (0.12.10) ...
Setting up runc (1.0.0~rc10-0ubuntu1~18.04.2) ...
Setting up cgroupfs-mount (1.4) ...
Setting up containerd (1.3.3-0ubuntu1~18.04.2) ...
Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /lib/systemd/system/containerd.service.
Setting up bridge-utils (1.5-15ubuntu1) ...
Setting up ubuntu-fan (0.12.10) ...
Created symlink /etc/systemd/system/multi-user.target.wants/ubuntu-fan.service → /lib/systemd/system/ubuntu-fan.service.
Setting up pigz (2.4-1) ...
Setting up docker.io (19.03.6-0ubuntu1~18.04.2) ...
Adding group `docker' (GID 116) ...
Done.
Created symlink /etc/systemd/system/sockets.target.wants/docker.socket → /lib/systemd/system/docker.socket.
docker.service is a disabled or a static unit, not starting it.
Processing triggers for systemd (237-3ubuntu10.43) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for ureadahead (0.100.0-21) ...
root@worker02:/home/ubuntu# apt-get update && apt-get install -y apt-transport-https
Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease              
Reading package lists... Done                                                  
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following package was automatically installed and is no longer required:
  linux-headers-4.15.0-124
Use 'sudo apt autoremove' to remove it.
The following NEW packages will be installed:
  apt-transport-https
0 upgraded, 1 newly installed, 0 to remove and 14 not upgraded.
Need to get 1696 B of archives.
After this operation, 153 kB of additional disk space will be used.
Get:1 http://azure.archive.ubuntu.com/ubuntu bionic-updates/universe amd64 apt-transport-https all 1.6.12ubuntu0.2 [1696 B]
Fetched 1696 B in 0s (0 B/s)                  
Selecting previously unselected package apt-transport-https.
(Reading database ... 77027 files and directories currently installed.)
Preparing to unpack .../apt-transport-https_1.6.12ubuntu0.2_all.deb ...
Unpacking apt-transport-https (1.6.12ubuntu0.2) ...
Setting up apt-transport-https (1.6.12ubuntu0.2) ...
root@worker02:/home/ubuntu# curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
OK
root@worker02:/home/ubuntu# cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
> deb https://apt.kubernetes.io/ kubernetes-xenial main
>  EOF
> main
> 
> /
> q
> cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
> deb https://apt.kubernetes.io/ kubernetes-xenial main
> EOF
deb https://apt.kubernetes.io/ kubernetes-xenial main
 EOF
main

/
q
cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
root@worker02:/home/ubuntu# apt-get update
E: Malformed line 2 in source list /etc/apt/sources.list.d/kubernetes.list (type)
E: The list of sources could not be read.
root@worker02:/home/ubuntu# cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
> deb https://apt.kubernetes.io/ kubernetes-xenial main
> EOF
deb https://apt.kubernetes.io/ kubernetes-xenial main
root@worker02:/home/ubuntu# apt-get update
Hit:1 http://azure.archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://azure.archive.ubuntu.com/ubuntu bionic-updates InRelease
Hit:3 http://azure.archive.ubuntu.com/ubuntu bionic-backports InRelease
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease              
Get:5 https://packages.cloud.google.com/apt kubernetes-xenial InRelease [9383 B]
Get:6 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 Packages [43.3 kB]
Fetched 52.7 kB in 1s (58.5 kB/s) 
Reading package lists... Done
root@worker02:/home/ubuntu# apt-get install -y kubelet kubeadm kubectl
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following package was automatically installed and is no longer required:
  linux-headers-4.15.0-124
Use 'sudo apt autoremove' to remove it.
The following additional packages will be installed:
  conntrack cri-tools kubernetes-cni socat
The following NEW packages will be installed:
  conntrack cri-tools kubeadm kubectl kubelet kubernetes-cni socat
0 upgraded, 7 newly installed, 0 to remove and 14 not upgraded.
Need to get 68.7 MB of archives.
After this operation, 293 MB of additional disk space will be used.
Get:1 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 conntrack amd64 1:1.4.4+snapshot20161117-6ubuntu2 [30.6 kB]
Get:2 http://azure.archive.ubuntu.com/ubuntu bionic/main amd64 socat amd64 1.7.3.2-2ubuntu2 [342 kB]
Get:3 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 cri-tools amd64 1.13.0-01 [8775 kB]
Get:4 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubernetes-cni amd64 0.8.7-00 [25.0 MB]
Get:5 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubelet amd64 1.20.1-00 [18.9 MB]
Get:6 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubectl amd64 1.20.1-00 [7948 kB]
Get:7 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubeadm amd64 1.20.1-00 [7708 kB]
Fetched 68.7 MB in 3s (24.0 MB/s)
Selecting previously unselected package conntrack.
(Reading database ... 77031 files and directories currently installed.)
Preparing to unpack .../0-conntrack_1%3a1.4.4+snapshot20161117-6ubuntu2_amd64.deb ...
Unpacking conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Selecting previously unselected package cri-tools.
Preparing to unpack .../1-cri-tools_1.13.0-01_amd64.deb ...
Unpacking cri-tools (1.13.0-01) ...
Selecting previously unselected package kubernetes-cni.
Preparing to unpack .../2-kubernetes-cni_0.8.7-00_amd64.deb ...
Unpacking kubernetes-cni (0.8.7-00) ...
Selecting previously unselected package socat.
Preparing to unpack .../3-socat_1.7.3.2-2ubuntu2_amd64.deb ...
Unpacking socat (1.7.3.2-2ubuntu2) ...
Selecting previously unselected package kubelet.
Preparing to unpack .../4-kubelet_1.20.1-00_amd64.deb ...
Unpacking kubelet (1.20.1-00) ...
Selecting previously unselected package kubectl.
Preparing to unpack .../5-kubectl_1.20.1-00_amd64.deb ...
Unpacking kubectl (1.20.1-00) ...
Selecting previously unselected package kubeadm.
Preparing to unpack .../6-kubeadm_1.20.1-00_amd64.deb ...
Unpacking kubeadm (1.20.1-00) ...
Setting up conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Setting up kubernetes-cni (0.8.7-00) ...
Setting up cri-tools (1.13.0-01) ...
Setting up socat (1.7.3.2-2ubuntu2) ...
Setting up kubelet (1.20.1-00) ...
Created symlink /etc/systemd/system/multi-user.target.wants/kubelet.service → /lib/systemd/system/kubelet.service.
Setting up kubectl (1.20.1-00) ...
Setting up kubeadm (1.20.1-00) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
root@worker02:/home/ubuntu# apt-mark hold kubelet kubeadm kubectl
kubelet set on hold.
kubeadm set on hold.
kubectl set on hold.
root@worker02:/home/ubuntu#  docker info | grep-i cgroup
grep-i: command not found
root@worker02:/home/ubuntu# echo "export PATH=$PATH:/<path_to_grep>" >> ~/.bash_profile
root@worker02:/home/ubuntu#  docker info|grep-i cgroup
WARNING: No swap limit support
grep-i: command not found
root@worker02:/home/ubuntu# docker info
Client:
 Debug Mode: false

Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 0
 Server Version: 19.03.6
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
  Native Overlay Diff: false
 Logging Driver: json-file
 Cgroup Driver: cgroupfs
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: runc
 Default Runtime: runc
 Init Binary: docker-init
 containerd version: 
 runc version: 
 init version: 
 Security Options:
  apparmor
  seccomp
   Profile: default
 Kernel Version: 5.4.0-1031-azure
 Operating System: Ubuntu 18.04.5 LTS
 OSType: linux
 Architecture: x86_64
 CPUs: 2
 Total Memory: 7.776GiB
 Name: worker02
 ID: 3R4E:RJQ6:I34U:CQLT:NB62:XBDW:53ZK:KGAS:3S32:3XU6:OMG5:C6RF
 Docker Root Dir: /var/lib/docker
 Debug Mode: false
 Registry: https://index.docker.io/v1/
 Labels:
 Experimental: false
 Insecure Registries:
  127.0.0.0/8
 Live Restore Enabled: false

WARNING: No swap limit support
root@worker02:/home/ubuntu# cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
# Note: This dropin only works with kubeadm and kubelet v1.11+
[Service]
Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
# This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
EnvironmentFile=-/etc/default/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
root@worker02:/home/ubuntu# systemctl restart kubelet
root@worker02:/home/ubuntu# systemctl daemon-reload
root@worker02:/home/ubuntu# apt  install docker.io
Reading package lists... Done
Building dependency tree       
Reading state information... Done
docker.io is already the newest version (19.03.6-0ubuntu1~18.04.2).
The following package was automatically installed and is no longer required:
  linux-headers-4.15.0-124
Use 'sudo apt autoremove' to remove it.
0 upgraded, 0 newly installed, 0 to remove and 14 not upgraded.
root@worker02:/home/ubuntu# kubeadm join 10.0.0.4:6443 --token h5f4yg.ohh4d941d71bd6af \
>     --discovery-token-ca-cert-hash sha256:12ea4109ff769eb9ecc3f270593e3983a39b27bd2bd28b8f1eb392b68f7f8e5f 
[preflight] Running pre-flight checks
	[WARNING Service-Docker]: docker service is not enabled, please run 'systemctl enable docker.service'
	[WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.

root@worker02:/home/ubuntu# client_loop: send disconnect: Broken pipe
MacBook-Air:~ anshitagoel$ systemctl enable docker.service
-bash: systemctl: command not found
MacBook-Air:~ anshitagoel$ ssh ubuntu@13.65.39.24
The authenticity of host '13.65.39.24 (13.65.39.24)' can't be established.
ECDSA key fingerprint is SHA256:wZ4lq/tK1D6JE7mg/22RIZxtTJP35jC092kapMlLWUg.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '13.65.39.24' (ECDSA) to the list of known hosts.
ubuntu@13.65.39.24's password: 
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-1031-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Tue Dec 29 09:15:56 UTC 2020

  System load:  0.0               Processes:              129
  Usage of /:   8.7% of 28.90GB   Users logged in:        0
  Memory usage: 6%                IP address for eth0:    10.0.1.5
  Swap usage:   0%                IP address for docker0: 172.17.0.1


 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

4 packages can be updated.
0 updates are security updates.

New release '20.04.1 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


*** System restart required ***
Last login: Mon Dec 28 21:13:47 2020 from 52.149.196.225
ubuntu@worker02:~$ sudo su
root@worker02:/home/ubuntu# systemctl enable docker.service
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /lib/systemd/system/docker.service.
root@worker02:/home/ubuntu# kubeadm token create --print-join-command
failed to load admin kubeconfig: open /root/.kube/config: no such file or directory
To see the stack trace of this error execute with --v=5 or higher
root@worker02:/home/ubuntu# kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64
>  | tr -d '\n')"
bash: command substitution: line 5: syntax error near unexpected token `|'
bash: command substitution: line 5: ` | tr -d '\n')"'
root@worker02:/home/ubuntu# kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version| base64| tr -d '\n')"
The connection to the server localhost:8080 was refused - did you specify the right host or port?
The connection to the server localhost:8080 was refused - did you specify the right host or port?
root@worker02:/home/ubuntu# client_loop: send disconnect: Broken pipe
MacBook-Air:~ anshitagoel$ kubectl create -f policy.yaml
The connection to the server localhost:8080 was refused - did you specify the right host or port?
MacBook-Air:~ anshitagoel$ ssh ubuntu@13.65.39.24
ubuntu@13.65.39.24's password: 
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-1031-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Tue Dec 29 19:20:29 UTC 2020

  System load:  0.32              Processes:              142
  Usage of /:   8.8% of 28.90GB   Users logged in:        0
  Memory usage: 6%                IP address for eth0:    10.0.1.5
  Swap usage:   0%                IP address for docker0: 172.17.0.1

 * Introducing self-healing high availability clusters in MicroK8s.
   Simple, hardened, Kubernetes for production, from RaspberryPi to DC.

     https://microk8s.io/high-availability

 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

4 packages can be updated.
0 updates are security updates.


*** System restart required ***
Last login: Tue Dec 29 09:15:57 2020 from 116.75.201.206
ubuntu@worker02:~$ sudo su
root@worker02:/home/ubuntu# APISERVER=$(kubectl config view -o jsonpath='{.clusters[0].cluster.server}')
root@worker02:/home/ubuntu# kubectl config set-cluster kubernetes \
>     --certificate-authority=/etc/kubernetes/pki/ca.crt \
>     --embed-certs=true \
>     --server=$APISERVER \
>     --kubeconfig=cni.kubeconfig
Cluster "kubernetes" set.
root@worker02:/home/ubuntu# 
root@worker02:/home/ubuntu# kubectl config set-credentials calico-cni \
>     --client-certificate=cni.crt \
>     --client-key=cni.key \
>     --embed-certs=true \
>     --kubeconfig=cni.kubeconfig
error: could not stat client-certificate file cni.crt: stat cni.crt: no such file or directory
root@worker02:/home/ubuntu# 
root@worker02:/home/ubuntu# kubectl config set-context default \
>     --cluster=kubernetes \
>     --user=calico-cni \
>     --kubeconfig=cni.kubeconfig
Context "default" created.
root@worker02:/home/ubuntu# 
root@worker02:/home/ubuntu# kubectl config use-context default --kubeconfig=cni.kubeconfig
Switched to context "default".
root@worker02:/home/ubuntu# kubeadm token create --print-join-command
failed to load admin kubeconfig: open /root/.kube/config: no such file or directory
To see the stack trace of this error execute with --v=5 or higher
root@worker02:/home/ubuntu# kubectl apply -f - <<EOF
> kind: ClusterRole
> apiVersion: rbac.authorization.k8s.io/v1
> metadata:
>   name: calico-cni
> rules:
>   # The CNI plugin needs to get pods, nodes, and namespaces.
>   - apiGroups: [""]
>     resources:
>       - pods
>       - nodes
>       - namespaces
>     verbs:
>       - get
>   # The CNI plugin patches pods/status.
>   - apiGroups: [""]
>     resources:
>       - pods/status
>     verbs:
>       - patch
>  # These permissions are required for Calico CNI to perform IPAM allocations.
>   - apiGroups: ["crd.projectcalico.org"]
>     resources:
>       - blockaffinities
>       - ipamblocks
>       - ipamhandles
>     verbs:
>       - get
>       - list
>       - create
>       - update
>       - delete
>   - apiGroups: ["crd.projectcalico.org"]
>     resources:
>       - ipamconfigs
>       - clusterinformations
>       - ippools
>     verbs:
>       - get
>       - list
> EOF
The connection to the server localhost:8080 was refused - did you specify the right host or port?
root@worker02:/home/ubuntu# kubectl create clusterrolebinding calico-cni --clusterrole=calico-cni --user=calico-cni
error: failed to create clusterrolebinding: Post "http://localhost:8080/apis/rbac.authorization.k8s.io/v1/clusterrolebindings?fieldManager=kubectl-create": dial tcp 127.0.0.1:8080: connect: connection refused
root@worker02:/home/ubuntu# curl -L -o /opt/cni/bin/calico https://github.com/projectcalico/cni-plugin/releases/download/v3.14.0/calico-amd64
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   636  100   636    0     0   3072      0 --:--:-- --:--:-- --:--:--  3072
100 37.7M  100 37.7M    0     0  27.9M      0  0:00:01  0:00:01 --:--:-- 33.4M
root@worker02:/home/ubuntu# chmod 755 /opt/cni/bin/calico
root@worker02:/home/ubuntu# curl -L -o /opt/cni/bin/calico-ipam https://github.com/projectcalico/cni-plugin/releases/download/v3.14.0/calico-ipam-amd64
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   641  100   641    0     0   3253      0 --:--:-- --:--:-- --:--:--  3253
100 36.8M  100 36.8M    0     0  31.1M      0  0:00:01  0:00:01 --:--:-- 79.0M
root@worker02:/home/ubuntu# chmod 755 /opt/cni/bin/calico-ipam
root@worker02:/home/ubuntu# mkdir -p /etc/cni/net.d/
root@worker02:/home/ubuntu# cp cni.kubeconfig /etc/cni/net.d/calico-kubeconfig
root@worker02:/home/ubuntu# chmod 600 /etc/cni/net.d/calico-kubeconfig
root@worker02:/home/ubuntu# cat > /etc/cni/net.d/10-calico.conflist <<EOF
> {
>   "name": "k8s-pod-network",
>   "cniVersion": "0.3.1",
>   "plugins": [
>     {
>       "type": "calico",
>       "log_level": "info",
>       "datastore_type": "kubernetes",
>       "mtu": 1500,
>       "ipam": {
>           "type": "calico-ipam"
>       },
>       "policy": {
>           "type": "k8s"
>       },
>       "kubernetes": {
>           "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
>       }
>     },
>     {
>       "type": "portmap",
>       "snat": true,
>       "capabilities": {"portMappings": true}
>     }
>   ]
> }
> EOF
root@worker02:/home/ubuntu# 
